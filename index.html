<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>原子物理课助教</title>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            background-color: #f5f5f5;
        }
        
        .header {
            background-color: #4a56e2;
            color: white;
            padding: 15px 20px;
            text-align: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .container {
            flex: 1;
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
        }
        
        .chat-container {
            flex: 1;
            background-color: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            height: 70vh;
        }
        
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }
        
        .message {
            margin-bottom: 15px;
            border-radius: 10px;
            padding: 10px 15px;
            max-width: 80%;
            animation: fadeIn 0.3s ease-in-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .user-message {
            background-color: #e3f2fd;
            align-self: flex-end;
            margin-left: auto;
        }
        
        .assistant-message {
            background-color: #f1f1f1;
            align-self: flex-start;
        }
        
        .thinking-block {
            background-color: #fff8e1;
            border-left: 3px solid #ffca28;
            padding: 10px 15px;
            margin-top: 10px;
            border-radius: 5px;
            font-size: 0.9em;
            color: #5d4037;
        }
        
        .status {
            text-align: center;
            padding: 10px;
            color: #757575;
            font-style: italic;
            border-top: 1px solid #eeeeee;
        }
        
        .chat-input {
            display: flex;
            padding: 15px;
            background-color: #f9f9f9;
            border-top: 1px solid #eeeeee;
        }
        
        #message-input {
            flex: 1;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 20px;
            margin-right: 10px;
            font-size: 1em;
            resize: none;
            outline: none;
            transition: border-color 0.3s;
        }
        
        #message-input:focus {
            border-color: #4a56e2;
        }
        
        #send-button {
            background-color: #4a56e2;
            color: white;
            border: none;
            border-radius: 20px;
            padding: 8px 20px;
            cursor: pointer;
            font-size: 1em;
            transition: background-color 0.3s;
        }
        
        #send-button:hover {
            background-color: #3a46c2;
        }
        
        #send-button:disabled {
            background-color: #cacaca;
            cursor: not-allowed;
        }
        
        .footer {
            text-align: center;
            padding: 15px;
            color: #757575;
            font-size: 0.8em;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>原子物理课助教</h1>
        <p>使用AI助手解答原子物理学相关问题</p>
    </div>
    
    <div class="container">
        <div class="chat-container">
            <div class="chat-messages" id="chat-messages">
                <div class="message assistant-message">
                    你好！我是原子物理课AI助教。你可以向我提问任何与原子物理相关的问题，例如：量子力学基础、原子结构、光谱学等。请问有什么我能帮助你的？
                </div>
            </div>
            <div class="status" id="status"></div>
            <div class="chat-input">
                <textarea 
                    id="message-input" 
                    placeholder="在这里输入你的问题..." 
                    rows="2"
                    onkeydown="if(event.keyCode == 13 && !event.shiftKey) { event.preventDefault(); sendMessage(); }">
                </textarea>
                <button id="send-button" onclick="sendMessage()">发送</button>
            </div>
        </div>
    </div>
    
    <div class="footer">
        © 2025 原子物理课助教 | 由AI大模型提供支持
    </div>

    <script>
        const apiKey = 'sk-497a22d6d2ac43b7b62a8a12470b4372';
        const appId = '4958e95571f44cfa8d6eb9ec15f29e01';
        const chatMessages = document.getElementById('chat-messages');
        const messageInput = document.getElementById('message-input');
        const sendButton = document.getElementById('send-button');
        const statusElement = document.getElementById('status');
        
        // 按下Enter发送消息
        messageInput.addEventListener('keydown', function(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        });
        
        async function sendMessage() {
            const userMessage = messageInput.value.trim();
            
            if (!userMessage) return;
            
            // 禁用输入和按钮
            messageInput.value = '';
            messageInput.disabled = true;
            sendButton.disabled = true;
            statusElement.textContent = '助教正在思考...';
            
            // 添加用户消息到聊天
            addMessage(userMessage, 'user');
            
            // 创建一个新的AI回复容器
            const assistantMessage = document.createElement('div');
            assistantMessage.className = 'message assistant-message';
            chatMessages.appendChild(assistantMessage);
            
            try {
                // 根据PHP示例和curl命令构建正确的API请求
                const apiUrl = `https://dashscope.aliyuncs.com/api/v1/apps/${appId}/completion`;
                
                // 监听数据流 - 需要使用XMLHttpRequest来处理流式响应
                const xhr = new XMLHttpRequest();
                xhr.open('POST', apiUrl, true);
                xhr.setRequestHeader('Content-Type', 'application/json');
                xhr.setRequestHeader('Authorization', `Bearer ${apiKey}`);
                xhr.setRequestHeader('X-DashScope-Streaming', 'true'); // 尝试启用流式输出
                
                // 变量用于跟踪响应和思考内容
                let normalText = '';
                let thinkText = '';
                let thinkingBlock = null;
                
                // 处理流式响应
                xhr.onprogress = function() {
                    // 获取当前接收到的响应
                    const response = xhr.responseText;
                    
                    try {
                        // 尝试解析为JSON - 注意我们可能会收到部分响应
                        const data = JSON.parse(response);
                        
                        if (data.output && data.output.text) {
                            const content = data.output.text;
                            
                            // 检查是否包含/think标记
                            if (content.includes('/think')) {
                                // 分离正常文本和思考内容
                                const parts = content.split('/think');
                                normalText = parts[0] || '';
                                
                                // 提取思考内容
                                if (parts.length > 1) {
                                    thinkText = parts[1];
                                }
                                
                                // 更新正常文本
                                assistantMessage.textContent = normalText;
                                
                                // 更新或创建思考块
                                if (!thinkingBlock && thinkText) {
                                    thinkingBlock = document.createElement('div');
                                    thinkingBlock.className = 'thinking-block';
                                    assistantMessage.appendChild(thinkingBlock);
                                }
                                
                                if (thinkingBlock) {
                                    thinkingBlock.innerHTML = `<strong>思考过程：</strong><br>${thinkText}`;
                                }
                            } else {
                                // 没有思考内容，直接显示
                                assistantMessage.textContent = content;
                            }
                        }
                    } catch (e) {
                        // 忽略解析错误，可能是响应未完成
                        console.log("解析响应时出错(可能是部分响应):", e);
                    }
                    
                    // 自动滚动到底部
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                };
                
                // 请求完成时的处理
                xhr.onload = function() {
                    if (xhr.status === 200) {
                        try {
                            const data = JSON.parse(xhr.responseText);
                            
                            if (data.output && data.output.text) {
                                const content = data.output.text;
                                
                                // 最终检查是否包含/think标记
                                if (content.includes('/think')) {
                                    const parts = content.split('/think');
                                    normalText = parts[0] || '';
                                    thinkText = parts.length > 1 ? parts[1] : '';
                                    
                                    assistantMessage.textContent = normalText;
                                    
                                    if (thinkText) {
                                        if (!thinkingBlock) {
                                            thinkingBlock = document.createElement('div');
                                            thinkingBlock.className = 'thinking-block';
                                            assistantMessage.appendChild(thinkingBlock);
                                        }
                                        thinkingBlock.innerHTML = `<strong>思考过程：</strong><br>${thinkText}`;
                                    }
                                } else {
                                    assistantMessage.textContent = content;
                                }
                            } else {
                                console.error("响应中没有文本内容:", data);
                                assistantMessage.textContent = "抱歉，我无法生成回复。";
                            }
                        } catch (e) {
                            console.error("解析最终响应时出错:", e);
                            assistantMessage.textContent = "抱歉，解析响应时出错。";
                        }
                    } else {
                        console.error("API请求失败:", xhr.status, xhr.responseText);
                        assistantMessage.textContent = `抱歉，请求失败 (${xhr.status})`;
                        
                        try {
                            const errorData = JSON.parse(xhr.responseText);
                            if (errorData.message) {
                                assistantMessage.textContent += `: ${errorData.message}`;
                            }
                        } catch (e) {
                            // 忽略解析错误
                        }
                    }
                    
                    // 恢复输入和按钮
                    messageInput.disabled = false;
                    sendButton.disabled = false;
                    messageInput.focus();
                    statusElement.textContent = '';
                };
                
                // 错误处理
                xhr.onerror = function() {
                    console.error("网络错误");
                    assistantMessage.textContent = "抱歉，发生网络错误。";
                    
                    // 恢复输入和按钮
                    messageInput.disabled = false;
                    sendButton.disabled = false;
                    messageInput.focus();
                    statusElement.textContent = '';
                };
                
                // 发送请求
                const requestBody = {
                    input: {
                        prompt: userMessage
                    },
                    parameters: {
                        stream: true  // 尝试启用流式输出
                    }
                };
                
                xhr.send(JSON.stringify(requestBody));
                
            } catch (error) {
                console.error('错误:', error);
                assistantMessage.textContent = `发生错误: ${error.message}`;
                
                // 恢复输入和按钮
                messageInput.disabled = false;
                sendButton.disabled = false;
                messageInput.focus();
                statusElement.textContent = '';
            }
        }
        
        function addMessage(text, sender) {
            const messageElement = document.createElement('div');
            messageElement.className = `message ${sender}-message`;
            messageElement.textContent = text;
            chatMessages.appendChild(messageElement);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // 备选方法：使用非流式请求
        async function sendMessageNonStreaming() {
            const userMessage = messageInput.value.trim();
            
            if (!userMessage) return;
            
            // 禁用输入和按钮
            messageInput.value = '';
            messageInput.disabled = true;
            sendButton.disabled = true;
            statusElement.textContent = '助教正在思考...';
            
            // 添加用户消息到聊天
            addMessage(userMessage, 'user');
            
            try {
                // 根据PHP示例构建正确的API请求
                const apiUrl = `https://dashscope.aliyuncs.com/api/v1/apps/${appId}/completion`;
                
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: JSON.stringify({
                        input: {
                            prompt: userMessage
                        }
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`API错误: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data.output && data.output.text) {
                    const content = data.output.text;
                    
                    // 检查是否包含/think标记
                    if (content.includes('/think')) {
                        const parts = content.split('/think');
                        const normalText = parts[0] || '';
                        const thinkText = parts.length > 1 ? parts[1] : '';
                        
                        // 添加正常文本
                        addMessage(normalText, 'assistant');
                        
                        // 如果有思考内容，添加思考块
                        if (thinkText) {
                            const lastMessage = chatMessages.lastElementChild;
                            const thinkingBlock = document.createElement('div');
                            thinkingBlock.className = 'thinking-block';
                            thinkingBlock.innerHTML = `<strong>思考过程：</strong><br>${thinkText}`;
                            lastMessage.appendChild(thinkingBlock);
                        }
                    } else {
                        // 没有思考内容，直接显示
                        addMessage(content, 'assistant');
                    }
                } else {
                    addMessage("抱歉，我无法生成回复。", 'assistant');
                }
                
            } catch (error) {
                console.error('错误:', error);
                addMessage(`发生错误: ${error.message}`, 'assistant');
            } finally {
                // 恢复输入和按钮
                messageInput.disabled = false;
                sendButton.disabled = false;
                messageInput.focus();
                statusElement.textContent = '';
            }
        }
    </script>
</body>
</html>
